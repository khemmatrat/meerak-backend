================================================================================
SECURITY NOTES â€” AUDIT-SAFE PAYMENT SYSTEM (REAL MONEY)
================================================================================
Thailand only: PromptPay, Bank Transfer, TrueMoney. No Stripe/foreign rails.

--------------------------------------------------------------------------------
WHY THIS SYSTEM IS NOW AUDIT-SAFE
--------------------------------------------------------------------------------

1. AUTHENTICATION & AUTHORIZATION
   - user_id for all money APIs comes ONLY from verified JWT (req.user.id).
   - Body/query user_id is IGNORED for wallet topup, withdraw, balance.
   - No code path mutates wallet or ledger without JWT + DB transaction + idempotency_key.
   - Roles: USER (wallet only), ADMIN (reconciliation + ops), AUDITOR (read-only).
   - Reconciliation run and reconciliation upload require ADMIN.
   - Audit read-only routes (GET /api/audit/ledger, reconciliation, logs) require AUDITOR or ADMIN.

2. SINGLE SOURCE OF TRUTH
   - When REAL_MONEY_MODE=true, all wallet ops MUST use backend ledger.
   - Firebase fallback is DISABLED; backend downtime fails the transaction (no silent fallback).
   - Balance when REAL_MONEY_MODE is not written to Firebase on success (return profile with backend balance).

3. LEDGER & IDEMPOTENCY
   - Double-entry, append-only ledger (PostgreSQL); triggers forbid UPDATE/DELETE.
   - Idempotency key required for topup and withdraw; duplicate key returns same result without double apply.
   - Platform fee is a separate ledger leg (FEE_REVENUE); never implicit.

4. RECONCILIATION
   - Settlement file upload (CSV or JSON) via POST /api/admin/reconciliation/upload.
   - Who uploaded, source, checksum, run_id stored immutably (reconciliation_uploads + financial_audit_log).
   - Reconciliation runs and lines are immutable; manual overrides (when added) must be logged with reason.

5. AUDIT LOG
   - financial_audit_log is append-only (triggers); no one can alter or delete.
   - Every wallet topup, withdraw, reconciliation run, and reconciliation upload is logged with actor, reason, state_after (and state_before where applicable).

6. SEPARATION OF DUTIES
   - Developer: code/deploy; no direct DB write to ledger/audit in production (all via API).
   - Finance/Admin: reconciliation upload, run; must use ADMIN role.
   - Auditor: read-only (GET /api/audit/*); AUDITOR or ADMIN role; no mutation privileges.

--------------------------------------------------------------------------------
ENVIRONMENT CONFIG (REQUIRED FOR PRODUCTION)
--------------------------------------------------------------------------------

Backend (.env or env vars):
  JWT_SECRET          - Required for production. When set, all /api/wallet, /api/reconciliation, /api/admin, /api/audit require valid Bearer token with sub (user id) and optional role (USER|ADMIN|AUDITOR).
  NODE_ENV=production - Enables JWT enforcement (no mock user when JWT_SECRET is set).
  DB_*                - PostgreSQL connection for ledger, wallets, reconciliation, audit.
  REDIS_URL           - Optional; used for webhook idempotency.

Frontend (Vite):
  VITE_REAL_MONEY_MODE=true - When set, wallet topup/withdraw MUST use backend; no Firebase fallback; backend failure fails the transaction.
  VITE_API_URL              - Backend base URL (for API calls).

--------------------------------------------------------------------------------
REMAINING NON-BLOCKING RISKS (MITIGATED)
--------------------------------------------------------------------------------

- JWT issuance: Backend trusts JWT payload (sub, role). Ensure auth service issues JWTs with correct sub and role; optionally sync role from user_roles table (009) when issuing token.
- Balance display: When REAL_MONEY_MODE=true, balance after topup/withdraw comes from backend response; getProfile may still read wallet_balance from Firebase for other pages. Optional: call GET /api/wallet/balance when REAL_MONEY_MODE for profile balance.
- DB role auditor_readonly: Migration 009 adds user_roles table; PostgreSQL role auditor_readonly (SELECT-only on ledger_entries, reconciliation_*, financial_audit_log, wallets) can be added for DB-level enforcement; API already restricts GET /api/audit/* to AUDITOR or ADMIN.

================================================================================
END
================================================================================
